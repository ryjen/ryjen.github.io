<!doctype html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Droid Fortunes: An Experiment in Android Widgets</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="google-site-verification" content="Crk6W-ckoApRrOZrv23ngLwPPTbzjzfZ4AQPElgS0pw" />
<meta name="description" content="personal blog of an engineer, musician, and madman" />
<meta name="robots" content="index, follow">


<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,900;1,200;1,300;1,400;1,500;1,600;1,700;1,900&family=Source+Sans+Pro:ital,wght@0,200;0,300;0,400;0,600;0,700;0,900;1,200;1,300;1,400;1,600;1,700;1,900&display=swap" rel="preload" type="font/otf" as="font">
<link rel="stylesheet" href="/css/theme.min.css" type="text/css">


<link href="/css/app.min.css" rel="stylesheet" type="text/css">



  </head>
  <body >
    <header id="header" class="shoulders">
      
        <nav class="navbar" role="navigation" aria-label="main navigation">
  <div class="navbar-brand">

    <a class="navbar-item" href="/">
      <figure class="image is-32x32 mr-3">
        <img class="is-rounded" src="/image/logo-profile.png" alt="logo">
      </figure>
      ryan jennings
    </a>

    <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="#nav">
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
    </a>
  </div>
  <div id="nav" class="navbar-menu">
    
    <div class="navbar-end">
      












    
  <a class="navbar-item" href="/posts">
    <span class="icon is-small mr-3">
  <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <use xlink:href="/fonts/solid.svg#rss"></use>
  </svg>
</span>
    blog
  </a>




    
  <a class="navbar-item" href="/art">
    <span class="icon is-small mr-3">
  <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <use xlink:href="/fonts/solid.svg#icons"></use>
  </svg>
</span>
    art
  </a>




    
  <a class="navbar-item" href="/things">
    <span class="icon is-small mr-3">
  <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <use xlink:href="/fonts/solid.svg#object-ungroup"></use>
  </svg>
</span>
    things
  </a>




    
  <a class="navbar-item" href="/about">
    <span class="icon is-small mr-3">
  <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <use xlink:href="/fonts/solid.svg#info-circle"></use>
  </svg>
</span>
    about
  </a>




<a role="button" class="navbar-item themer" href="#">
  <span class="icon is-small">
  <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <use xlink:href="/fonts/solid.svg#yin-yang"></use>
  </svg>
</span>
</a>



    </div>
    
  </div>
</nav>


      
    </header>

    <section id="main" class="abdomen">
      

  
<nav class="breadcrumb ml-4 is-small" aria-label="breadcrumbs">
  <ul>
    









<li>
    <a href="/">Home</a>
</li>




<li>
    <a href="/archive/">Blog Archives</a>
</li>




<li class="is-active">
    <a href="/archive/droid-fortunes-an-experiment-in-android-widgets/">Droid Fortunes: An Experiment in Android Widgets</a>
</li>


  </ul>
</nav>





  <div class="container">

  
  <h1 class="title">Droid Fortunes: An Experiment in Android Widgets</h1>
  

  <div class="content">
    <h2 id="background">Background</h2>
<p>I have it set up on my OSX machine to give me a random <a href="http://en.wikipedia.org/wiki/Fortune_%28Unix%29">fortune</a> when I log into the shell.
I thought it would be a good idea to port this to Android in the form of a widget and Droid Fortunes was born!</p>
<p>So a little more background on the the &lsquo;fortune&rsquo; command for those who do not know.  The program itself is simple enough - display a random message stored in a database.  The &lsquo;database&rsquo; is actually a collection of files representing a &lsquo;category&rsquo;.  Each category has a list of messages separated by a &lsquo;%&rsquo; on a new line.</p>
<p>Fortunes are mapped to a random-access data file using &lsquo;strfile&rsquo; (basically a header with size information followed by a list of addresses for each message in the file).</p>
<p>Fortunes also have the concept of an &lsquo;offensive&rsquo; fortunes, which are encoded using <a href="http://en.wikipedia.org/wiki/ROT13">rot13</a> so anyone viewing the files is not offended.</p>
<h2 id="testing">Testing</h2>
<p>My original prototype of Droid Fortunes attempted to mimic the C implementation by decoding the random access data files.  This was a problem because the addresses in the data file were not portable.</p>
<p>My second prototype used the raw data files and this was a problem as well because it was pretty slow.</p>
<p>At this point, its obvious a database is needed.  I wrote a very simple &lsquo;<a href="git://gist.github.com/3051477.git">fortune2sqlite</a>&rsquo; converter utility to create and populate a sqlite database. After some attempts at importing a sql script, I finally ended up copying the pre-generated database from resources into user-space for use.</p>
<h2 id="ui">UI</h2>
<h3 id="widget-layout">Widget Layout</h3>
<p>So data taken care of, it needs a UI.  Turns out android Widgets use something called &lsquo;<a href="http://developer.android.com/reference/android/widget/RemoteViews.html">RemoteViews</a>&rsquo; to update its UI without an application running.  This is the route a widget must take to transmit information to the Launcher process.  This means you cannot use the typical &lsquo;findViewById()&rsquo; method to coordinate data/UI.  My original implementation was mainly figuring out the RemoteViews usage the event handling. While it worked was not very pretty as I am not a graphic designer.</p>
<p>I have since found the &lsquo;Protips&rsquo; widget from the OS (available as open source) which was very similar to what I was doing except displaying Android tips instead of fortunes - hence I&rsquo;ve updated my UI to mimic that widget.  Eventually I will replace the little &lsquo;droid&rsquo; character with something custom.</p>
<p><img src="/images/blog/droidfortunes.png" alt="DroidFortunes Widget View"></p>
<p>Another issue is that the widgets are not always going to be able to display the full fortune text.  ScrollView is not available in widgets, so my alternative was to add an ellipsis after 5 lines (&hellip;) and open a full activity display when the widget is clicked.  I also added two buttons on bottom left/right corners - one for settings and one for manually advancing to the next fortune.</p>
<p>![<a href="/images/blog/droidfortunes_details.png">DroidFortunes Details View</a></p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">    <span style="color:#fff;font-weight:bold">SELECT</span> f.* <span style="color:#fff;font-weight:bold">FROM</span> fortunes f <span style="color:#fff;font-weight:bold">JOIN</span> category <span style="color:#fff;font-weight:bold">c</span> <span style="color:#fff;font-weight:bold">ON</span> f.<span style="color:#fff;font-weight:bold">type</span> = <span style="color:#fff;font-weight:bold">c</span>.name <span style="color:#fff;font-weight:bold">WHERE</span> <span style="color:#fff;font-weight:bold">c</span>.enabled <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> RANDOM() <span style="color:#fff;font-weight:bold">LIMIT</span> <span style="color:#ff0;font-weight:bold">1</span>
</code></pre></div><p>Nice and simple query gets the job done.</p>
<h3 id="settings">Settings</h3>
<p>Haven&rsquo;t quite finished implementing this yet but basically I want to be able to turn on/off fortune categories and offensive fortunes.</p>
<p>Eventually I would like to implement importing new UNIX fortunes or adding your own fortunes (maybe from funny text messages or something). I would like this to be a paid feature, but I&rsquo;ll have to make sure I&rsquo;m not infringing on any licenses by using the fortune database.</p>
<p><img src="/images/blog/droidfortunes_settings.png" alt="DroidFortunes Settings View"></p>
<h2 id="conclusion">Conclusion</h2>
<p>So all in all, I&rsquo;m pleased with the result.  It took me approximately 30 hours to get this far but the grunt work is done.</p>

  </div>

  



  



  </div>


    </section>

    <footer id="footer" class="legs">
      









<div class="has-text-centered content">

  <div class="is-flex is-align-items-center is-justify-content-center">
    
    <div class="has-text-centered m-3">
      <button id="themer" class="themer" type="button">enlighten</button>
    </div>
    <a href="https://github.com/ryjen/ryjen.github.io/issues/new">See an issue?</a> 
  </div>

  <div class="copyright">
  Â© all rights reserved, ryan jennings 
  </div>
</div>


    </footer>

    
<script src="/js/vendor.min.js" defer></script>
<script src="/js/theme.min.js" defer></script>


<script src="/js/app.min.js" defer></script>




<script data-goatcounter="https://analytics.micrantha.com/count"
        async src="//analytics.micrantha.com/count.js"></script>






  </body>
</html>
