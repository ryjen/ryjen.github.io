<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>C Sqlite Tricks</title>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="dark light"><meta name=google-site-verification content="Crk6W-ckoApRrOZrv23ngLwPPTbzjzfZ4AQPElgS0pw"><meta name=description content="Web logs of a software development engineer, musician, artist and hockey player."><meta name=robots content="index, follow"><link rel=stylesheet href=/css/theme.min.css type=text/css><link href=/css/app.min.css rel=stylesheet type=text/css></head><body class=dark><header id=header class=shoulders><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=navbar-item href=/><figure class="image is-32x32 mr-3"><img class=is-rounded src=/image/logo-profile.jpg alt=logo></figure>ryan jennings
</a><a role=button class=navbar-burger aria-label=menu aria-expanded=false data-target=nav><span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span></a></div><div id=nav class=navbar-menu><div class=navbar-end><a class=navbar-item href=/posts><span class="icon is-small mr-3"><svg xmlns:xlink="http://www.w3.org/1999/xlink"><use xlink:href="/fonts/solid.svg#rss"/></svg>
</span>blog
</a><a class=navbar-item href=/art><span class="icon is-small mr-3"><svg xmlns:xlink="http://www.w3.org/1999/xlink"><use xlink:href="/fonts/solid.svg#icons"/></svg>
</span>art
</a><a class=navbar-item href=/things><span class="icon is-small mr-3"><svg xmlns:xlink="http://www.w3.org/1999/xlink"><use xlink:href="/fonts/solid.svg#object-ungroup"/></svg>
</span>things
</a><a class=navbar-item href=/about><span class="icon is-small mr-3"><svg xmlns:xlink="http://www.w3.org/1999/xlink"><use xlink:href="/fonts/solid.svg#info-circle"/></svg>
</span>about
</a><a role=button class="navbar-item themer" href=#><span class="icon is-small"><svg xmlns:xlink="http://www.w3.org/1999/xlink"><use xlink:href="/fonts/solid.svg#yin-yang"/></svg></span></a></div></div></nav></header><section id=main class=abdomen><nav class="breadcrumb ml-4 is-small" aria-label=breadcrumbs><ul><li><a href=/>Home</a></li><li><a href=/archive/>Blog Archives</a></li><li class=is-active><a href=/archive/c-sqlite-tricks/>C Sqlite Tricks</a></li></ul></nav><div class=container><h1 class=title>C Sqlite Tricks</h1><div class=content><h4 id=introduction>Introduction</h4><p>Thought I would share some tricks I use for easy data CRUD&rsquo;s in C. I&rsquo;m using Sqlite here, but could apply to any database.</p><p>Not saying its the best approach at all (nor <a href=https://github.com/ryjen/db>ryjen/db</a>), this is just how it evolved for me.</p><h4 id=mapping>Mapping</h4><p>The core of my data access is the FieldMap structure, which determines how to save each field to the database.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     * this is the magical table used to communicate between memory and the database
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>typedef</span> <span class=k>struct</span> <span class=n>FieldMap</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>const</span> <span class=kt>char</span>   <span class=o>*</span><span class=n>name</span><span class=p>;</span>        <span class=cm>/* name of the field */</span>
</span></span><span class=line><span class=cl>      <span class=kt>void</span>        <span class=o>*</span><span class=n>value</span><span class=p>;</span>        <span class=cm>/* a pointer to the value of the field */</span>
</span></span><span class=line><span class=cl>      <span class=kt>int</span>         <span class=n>type</span><span class=p>;</span>          <span class=cm>/* type of value */</span>
</span></span><span class=line><span class=cl>      <span class=k>const</span> <span class=kt>void</span>   <span class=o>*</span><span class=n>arg1</span><span class=p>;</span>        <span class=cm>/* additional argument */</span>
</span></span><span class=line><span class=cl>      <span class=k>const</span> <span class=kt>void</span>   <span class=o>*</span><span class=n>arg2</span><span class=p>;</span>        <span class=cm>/* additional argument */</span>
</span></span><span class=line><span class=cl>      <span class=kt>int</span>         <span class=n>flags</span><span class=p>;</span>         <span class=cm>/* usage flags */</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>FieldMap</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* callback for custom field types */</span>
</span></span><span class=line><span class=cl>    <span class=k>typedef</span> <span class=nf>int</span> <span class=p>(</span><span class=o>*</span><span class=n>CustomField</span><span class=p>)</span> <span class=p>(</span><span class=n>sqlite3_stmt</span> <span class=o>*</span><span class=p>,</span> <span class=kt>int</span> <span class=n>column</span><span class=p>,</span> <span class=n>FieldMap</span> <span class=o>*</span><span class=n>field</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>typedef</span> <span class=nf>void</span> <span class=p>(</span><span class=o>*</span><span class=n>DbCallback</span><span class=p>)</span> <span class=p>(</span><span class=n>sqlite3_stmt</span> <span class=o>*</span><span class=p>);</span>
</span></span></code></pre></div><p>Basically you would have to:</p><h5 id=example-1---saving>Example 1 - Saving</h5><p>This high level example shows building a quick table for each field we want to save in the database. In this case, an account object.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* The account table name */</span>
</span></span><span class=line><span class=cl><span class=cp>#define ACCOUNT_TABLE &#34;account&#34;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* a structure representing the account fields */</span>
</span></span><span class=line><span class=cl><span class=n>FieldMap</span> <span class=n>account_values</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=s>&#34;login&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>acc</span><span class=o>-&gt;</span><span class=n>login</span><span class=p>,</span> <span class=n>SQL_TEXT</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=s>&#34;email&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>acc</span><span class=o>-&gt;</span><span class=n>email</span><span class=p>,</span> <span class=n>SQL_TEXT</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=s>&#34;password&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>acc</span><span class=o>-&gt;</span><span class=n>password</span><span class=p>,</span> <span class=n>SQL_TEXT</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=s>&#34;timezone&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>acc</span><span class=o>-&gt;</span><span class=n>timezone</span><span class=p>,</span> <span class=n>SQL_INT</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=mi>0</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* saves the fields to the database */</span>
</span></span><span class=line><span class=cl><span class=n>acc</span><span class=o>-&gt;</span><span class=n>id</span> <span class=o>=</span> <span class=nf>db_save</span><span class=p>(</span><span class=n>account_values</span><span class=p>,</span> <span class=n>ACCOUNT_TABLE</span><span class=p>,</span> <span class=n>acc</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>);</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>sqlite3_int64</span> <span class=nf>db_save</span><span class=p>(</span><span class=n>FieldMap</span> <span class=o>*</span><span class=n>table</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>tableName</span><span class=p>,</span> <span class=n>sqlite3_int64</span> <span class=o>*</span><span class=n>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>id</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>db_insert_query</span><span class=p>(</span><span class=n>table</span><span class=p>,</span> <span class=n>tableName</span><span class=p>)</span> <span class=o>!=</span> <span class=n>SQL_OK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>error</span><span class=p>(</span><span class=s>&#34;could not insert&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>db_last_insert_rowid</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>db_update_query</span><span class=p>(</span><span class=n>table</span><span class=p>,</span> <span class=n>tableName</span><span class=p>,</span> <span class=o>*</span><span class=n>id</span><span class=p>)</span> <span class=o>!=</span> <span class=n>SQL_OK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>error</span><span class=p>(</span><span class=s>&#34;could not update&#34;</span><span class=p>,);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=example-2---deeper-into-saving>Example 2 - Deeper into Saving</h4><p>The first part of saving is inserting. The steps are to build a query, bind the values, and execute. In the case the values from the field map table for an account.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>sql_insert_query</span><span class=p>(</span><span class=n>FieldMap</span> <span class=o>*</span><span class=n>table</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>tablename</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>sqlite3_stmt</span> <span class=o>*</span><span class=n>stmt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>1024</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>columns</span><span class=p>[</span><span class=mi>1024</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>params</span><span class=p>[</span><span class=mi>1024</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* create a csv list of columns and params */</span>
</span></span><span class=line><span class=cl>  <span class=nf>db_build_columns</span><span class=p>(</span><span class=n>table</span><span class=p>,</span> <span class=n>columns</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>db_build_params</span><span class=p>(</span><span class=n>table</span><span class=p>,</span> <span class=n>params</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>len</span> <span class=o>=</span>  <span class=nf>sprintf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=s>&#34;INSERT INTO %s (%s) VALUES(%s)&#34;</span><span class=p>,</span> <span class=n>tablename</span><span class=p>,</span> <span class=n>columns</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>params</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>sqlite3_query</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=n>len</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>stmt</span><span class=p>)</span> <span class=o>!=</span> <span class=n>SQL_OK</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>sql_finalize</span><span class=p>(</span><span class=n>stmt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>sqlite3_bind_values</span><span class=p>(</span><span class=n>stmt</span><span class=p>,</span> <span class=n>table</span><span class=p>)</span> <span class=o>!=</span> <span class=n>SQL_OK</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>sql_finalize</span><span class=p>(</span><span class=n>stmt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* execute */</span>
</span></span><span class=line><span class=cl>  <span class=nf>sqlite3_step</span><span class=p>(</span><span class=n>stmt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>sqlite3_finalize</span><span class=p>(</span><span class=n>stmt</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=example-3---binding>Example 3 - Binding</h4><p>Have to have a way to bind the FieldMap to the queries, so the following implementations take care of that.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>db_bind_values</span><span class=p>(</span><span class=n>sql_stmt</span> <span class=o>*</span><span class=n>stmt</span><span class=p>,</span> <span class=n>FieldMap</span> <span class=o>*</span><span class=n>table</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>table</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>name</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>err</span> <span class=o>=</span> <span class=nf>sql_bind_table_value</span><span class=p>(</span><span class=n>stmt</span><span class=p>,</span> <span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>table</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>err</span> <span class=o>!=</span> <span class=n>SQL_OK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>SQL_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * binds a single FieldMap value to a query
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>db_bind_table_value</span><span class=p>(</span><span class=n>sqlite3_stmt</span> <span class=o>*</span><span class=n>stmt</span><span class=p>,</span> <span class=kt>int</span> <span class=n>column</span><span class=p>,</span> <span class=n>FieldMap</span> <span class=o>*</span><span class=n>field</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>field</span><span class=o>-&gt;</span><span class=n>value</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>sqlite3_bind_null</span><span class=p>(</span><span class=n>stmt</span><span class=p>,</span> <span class=n>column</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>(</span><span class=n>field</span><span class=o>-&gt;</span><span class=n>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=nl>SQL_INT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>sqlite3_bind_int</span><span class=p>(</span><span class=n>stmt</span><span class=p>,</span> <span class=n>column</span><span class=p>,</span> <span class=o>*</span><span class=p>((</span><span class=kt>int</span><span class=o>*</span><span class=p>)</span> <span class=n>field</span><span class=o>-&gt;</span><span class=n>value</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=nl>SQL_TEXT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>str</span> <span class=o>=</span> <span class=o>*</span><span class=p>((</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>field</span><span class=o>-&gt;</span><span class=n>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nf>sqlite3_bind_text</span><span class=p>(</span><span class=n>stmt</span><span class=p>,</span> <span class=n>column</span><span class=p>,</span> <span class=n>str</span><span class=p>,</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>str</span><span class=p>),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=nl>SQL_DOUBLE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>sqlite3_bind_double</span><span class=p>(</span><span class=n>stmt</span><span class=p>,</span> <span class=n>column</span><span class=p>,</span> <span class=o>*</span><span class=p>((</span><span class=kt>double</span><span class=o>*</span><span class=p>)</span> <span class=n>field</span><span class=o>-&gt;</span><span class=n>value</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=nl>SQL_FLOAT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>sqlite3_bind_float</span><span class=p>(</span><span class=n>stmt</span><span class=p>,</span> <span class=n>column</span><span class=p>,</span> <span class=o>*</span><span class=p>((</span><span class=kt>float</span><span class=o>*</span><span class=p>)</span> <span class=n>field</span><span class=o>-&gt;</span><span class=n>value</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=nl>SQL_CUSTOM</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>custom_sql</span> <span class=n>func</span> <span class=o>=</span> <span class=p>(</span><span class=n>custom_sql</span><span class=p>)</span> <span class=p>(</span><span class=n>field</span><span class=o>-&gt;</span><span class=n>arg1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>assert</span><span class=p>(</span><span class=n>func</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=o>*</span><span class=n>func</span><span class=p>)</span> <span class=p>(</span><span class=n>stmt</span><span class=p>,</span> <span class=n>column</span><span class=p>,</span> <span class=n>field</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=nf>error</span><span class=p>(</span><span class=s>&#34;unknown save type for field %s&#34;</span><span class=p>,</span> <span class=n>field</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>SQL_NONTYPE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=example-4---loading>Example 4 - Loading</h4><p>This high level example shows loading an account by an id using the same table.</p><p>The the query results are assigned to the pointers in the table.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* loads one account by id */</span>
</span></span><span class=line><span class=cl><span class=n>res</span> <span class=o>=</span> <span class=nf>db_load_by_id</span><span class=p>(</span><span class=n>account_values</span><span class=p>,</span> <span class=n>ACCOUNT_TABLE</span><span class=p>,</span> <span class=n>acc</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>);</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>db_load_by_id</span><span class=p>(</span><span class=n>FieldMap</span> <span class=o>*</span><span class=n>table</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>tablename</span><span class=p>,</span> <span class=n>sql_int64</span> <span class=n>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>1024</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>sprintf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=s>&#34;where %s=&#39;%lld&#39;&#34;</span><span class=p>,</span> <span class=nf>tablenameId</span><span class=p>(</span><span class=n>tablename</span><span class=p>),</span> <span class=n>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=nf>db_select_query</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>table</span><span class=p>,</span> <span class=n>tablename</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>buf</span><span class=p>)</span> <span class=o>!=</span> <span class=n>SQL_OK</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>error</span><span class=p>(</span><span class=s>&#34;could not load&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Load multiple accounts by using a callback method.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>res</span> <span class=o>=</span> <span class=nf>db_load_all</span><span class=p>(</span><span class=n>ACCOUNT_TABLE</span><span class=p>,</span> <span class=n>load_account_callback</span><span class=p>);</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>db_load_all</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>tableName</span><span class=p>,</span> <span class=n>DbCallback</span> <span class=n>callback</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>db_select_query</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>tableName</span><span class=p>,</span> <span class=n>callback</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>!=</span> <span class=n>SQL_OK</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>error</span><span class=p>(</span><span class=s>&#34;could not load&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=example-5---querying>Example 5 - Querying</h4><p>Querying is not too complicated. Its the typical process of create and execute looping the results. For each row it will:</p><ol><li>loading columns into the field map</li><li>issues the callback if provided</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>sql_select_query</span><span class=p>(</span><span class=n>FieldMap</span> <span class=o>*</span><span class=n>table</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>tablename</span><span class=p>,</span> <span class=n>DbCallback</span> <span class=n>callback</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>constraints</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>sqlite3_stmt</span> <span class=o>*</span><span class=n>stmt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>1024</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>columns</span><span class=p>[</span><span class=mi>1024</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>column</span><span class=p>,</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* creates a csv list of columns */</span>
</span></span><span class=line><span class=cl>  <span class=nf>db_build_columns</span><span class=p>(</span><span class=n>table</span><span class=p>,</span> <span class=n>columns</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>len</span> <span class=o>=</span> <span class=nf>sprintf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=s>&#34;SELECT %s,%s FROM %s %s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nf>tablenameId</span><span class=p>(</span><span class=n>tablename</span><span class=p>),</span> <span class=n>columns</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>tablename</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>constraints</span> <span class=o>?</span> <span class=nl>constraints</span> <span class=p>:</span> <span class=s>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>sqlite3_query</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=n>len</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>stmt</span><span class=p>)</span> <span class=o>!=</span> <span class=n>SQL_OK</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nf>sqlite3_finalize</span><span class=p>(</span><span class=n>stmt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=n>err</span> <span class=o>=</span> <span class=nf>sqlite3_step</span><span class=p>(</span><span class=n>stmt</span><span class=p>);</span> <span class=n>err</span> <span class=o>!=</span> <span class=n>SQL_DONE</span><span class=p>;</span> <span class=n>err</span> <span class=o>=</span> <span class=nf>sqlite3_step</span><span class=p>(</span><span class=n>stmt</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=cm>/* check for a table to load */</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=n>column</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>table</span> <span class=o>&amp;&amp;</span> <span class=n>table</span><span class=p>[</span><span class=n>column</span><span class=p>].</span><span class=n>name</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>column</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=cm>/* pass a pointer to the current position in the table */</span>
</span></span><span class=line><span class=cl>          <span class=nf>db_load_column</span><span class=p>(</span><span class=n>stmt</span><span class=p>,</span> <span class=n>column</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>table</span><span class=p>[</span><span class=n>column</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=cm>/* check for a callback */</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span><span class=p>(</span><span class=n>callback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nf>callback</span><span class=p>(</span><span class=n>stmt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>sqlite3_finalize</span><span class=p>(</span><span class=n>stmt</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=example-6---deeper-into-querying>Example 6 - Deeper into Querying</h4><p>You saw that querying will load each column in a row. This function shows how that is done.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>db_load_column</span><span class=p>(</span><span class=n>sqlite3_stmt</span> <span class=o>*</span><span class=n>stmt</span><span class=p>,</span> <span class=kt>int</span> <span class=n>column</span><span class=p>,</span> <span class=n>FieldMap</span> <span class=o>*</span><span class=n>field</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>(</span><span class=n>field</span><span class=o>-&gt;</span><span class=n>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=nl>SQL_INT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=nf>field_value</span><span class=p>(</span><span class=kt>int</span><span class=p>,</span> <span class=n>field</span><span class=p>)</span> <span class=o>=</span>  <span class=nf>sqlite3_column_int</span><span class=p>(</span><span class=n>stmt</span><span class=p>,</span> <span class=n>column</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=nl>SQL_TEXT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=nf>field_value</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=p>,</span> <span class=n>field</span><span class=p>)</span> <span class=o>=</span> <span class=nf>str_dup</span><span class=p>(</span><span class=nf>sqlite3_column_str</span><span class=p>(</span><span class=n>stmt</span><span class=p>,</span> <span class=n>column</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=nl>SQL_FLOAT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=nf>field_value</span><span class=p>(</span><span class=kt>float</span><span class=p>,</span> <span class=n>field</span><span class=p>)</span> <span class=o>=</span> <span class=nf>sqlite3_column_float</span><span class=p>(</span><span class=n>stmt</span><span class=p>,</span> <span class=n>column</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=nl>SQL_DOUBLE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=nf>field_value</span><span class=p>(</span><span class=kt>double</span><span class=p>,</span> <span class=n>field</span><span class=p>)</span> <span class=o>=</span> <span class=nf>sqlite3_column_double</span><span class=p>(</span><span class=n>stmt</span><span class=p>,</span> <span class=n>column</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=nl>SQL_CUSTOM</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>custom_sql</span> <span class=o>*</span><span class=n>func</span> <span class=o>=</span>  <span class=p>(</span><span class=n>custom_sql</span> <span class=o>*</span><span class=p>)</span> <span class=n>field</span><span class=o>-&gt;</span><span class=n>arg1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nf>assert</span><span class=p>(</span><span class=n>func</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>(</span><span class=o>*</span><span class=n>func</span><span class=p>)</span> <span class=p>(</span><span class=n>stmt</span><span class=p>,</span> <span class=n>column</span><span class=p>,</span> <span class=n>field</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The <code>field_value</code> macro turns the field map into something we can assign a result to.</p><h4 id=conclusion>Conclusion</h4><p>C is already a very verbose language, but defining and using a table structure for database operations saves a lot of boiler plate code.</p></div></div></section><footer id=footer class=legs><div class="has-text-centered content"><div class="is-flex is-align-items-center is-justify-content-center"><div class="has-text-centered m-3"><button id=themer class=themer type=button>enlighten</button></div><a href=https://github.com/ryjen/ryjen.github.io/issues/new>See an issue?</a></div><div class=copyright>© all rights reserved, ryan jennings</div></div></footer><script src=/js/theme.min.js defer></script><script src=/js/app.min.js defer></script><script async defer data-website-id=b348cf02-9212-4e45-be35-bd529c1eb47a src=https://analytics.micrantha.com/umami.js></script></body></html>