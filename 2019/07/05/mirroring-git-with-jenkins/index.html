<!doctype html><html class=no-js lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Mirroring git with jenkins</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=google-site-verification content="Crk6W-ckoApRrOZrv23ngLwPPTbzjzfZ4AQPElgS0pw"><meta name=description content="personal blog of an engineer, musician, and madman"><meta name=ROBOTS content="INDEX, FOLLOW"><meta http-equiv=cache-control content="no-cache, no-store, must-revalidate"><meta http-equiv=pragma content="no-cache"><meta http-equiv=expires content="0"><link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,900;1,200;1,300;1,400;1,500;1,600;1,700;1,900&family=Source+Sans+Pro:ital,wght@0,200;0,300;0,400;0,600;0,700;0,900;1,200;1,300;1,400;1,600;1,700;1,900&display=swap" rel="stylesheet preload"><link rel="stylesheet preload" href=/css/theme.min.css><link href=/css/app.min.css rel=stylesheet></head><body><div id=header class=clearfix><div class="container clearfix"><div id=brand><a href=/><span class=brand>ryan jennings</span></a></div><div id=menu-toggle><i class="fas fa-bars"></i></div><nav><ul class="nav navbar-nav menu"><li class="nav-item nav-toggle"><a href=/verbage><i class="fas fa-newspaper"></i><span class=nav-name>verbage</span></a></li><ul class=nav-sub-menu><li class=nav-item><a href=/post><i class="fas fa-rss"></i><span class=nav-name>blog</span></a></li><li class=nav-item><a href=/musings><i class="fas fa-comment-dots"></i><span class=nav-name>musings</span></a></li></ul><li class="nav-item nav-toggle"><a href=/art><i class="fas fa-icons"></i><span class=nav-name>art</span></a></li><ul class=nav-sub-menu><li class=nav-item><a href=/music><i class="fas fa-music"></i><span class=nav-name>music</span></a></li><li class=nav-item><a href=/doodles><i class="fas fa-image"></i><span class=nav-name>doodles</span></a></li><li class=nav-item><a href=/post/poems><i class="fas fa-pen-nib"></i><span class=nav-name>poems</span></a></li></ul><li class="nav-item nav-toggle"><a href=/things><i class="fas fa-object-ungroup"></i><span class=nav-name>things</span></a></li><ul class=nav-sub-menu><li class=nav-item><a href=/things/books><i class="fas fa-book"></i><span class=nav-name>books</span></a></li><li class=nav-item><a href=/things/tech><i class="fas fa-robot"></i><span class=nav-name>tech</span></a></li></ul></ul></nav></div></div><div class=container><div id=main><div class=header><h1>Mirroring git with jenkins</h1><p class=subtitle>A short look at automating git repository mirroring.</p><div class="subheader clearfix"><div class=readinfo>ETA: 386 words, 2 minutes</div>&nbsp;|&nbsp;<div class=timestamps>Created: July 5, 2019</div></div></div><div class=text-justify><h2 id=introduction>Introduction</h2><p>For some software development projects, there may be a need to backup or mirror the repository to a different location.</p><p>Jenkins or other continuous integration (CI) can automate this. This log is a brief summary of how in case I need to reproduce.</p><h2 id=workflow>Workflow</h2><p>The requirement is to have a single jenkins job that synchronizes various other projects and repositories.</p><p>To do this, the job calls another job to mirror any source repository to any set of destination repositories.</p><h2 id=git-mirroring>Git Mirroring</h2><p>Git has mirroring capability built into <a href=https://www.git-scm.com/docs/git-clone#Documentation/git-clone.txt---mirror>cloning</a> and <a href=https://www.git-scm.com/docs/git-push#Documentation/git-push.txt---mirror>pushing</a>.</p><p>To make the Jenkins script easier you can also pass the remote URL to push, instead of adding a remote configuration.</p><p><code>git push git@host.org:user/repo</code></p><h2 id=jenkins>Jenkins</h2><p>You should have a list of the possible repositories you would use.</p><p>To allow for multiple destination repositories, add the <a href=https://wiki.jenkins.io/display/JENKINS/Extended+Choice+Parameter+plugin>Extended Choice Parameter</a>.</p><p>To keep things simple, all repositories should have the same <code>user/project</code> path.</p><h3 id=job-git-mirror>Job: Git Mirror</h3><p>A new pipeline job configured with the parameters:</p><ul><li>the source repository as a single selection from a list of repositories</li><li>the destination repository as a multi selection from the list of repositories.</li><li>the project path in the repositories</li></ul><p>The pipeline script looks like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy>node <span style=color:#f92672>{</span>
  stage <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Prepare&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    deleteDir<span style=color:#f92672>()</span>
    dest <span style=color:#f92672>=</span> sh<span style=color:#f92672>(</span>returnStdout: <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> script: <span style=color:#e6db74>&#39;echo &#34;${destination}&#34;&#39;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>().</span><span style=color:#a6e22e>tokenize</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#39;,&#39;</span><span style=color:#f92672>)</span>

    <span style=color:#75715e>// skip adding new host key to jenkins
</span><span style=color:#75715e></span>    sh <span style=color:#e6db74>&#39;git config --global core.sshCommand &#34;ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no&#34;&#39;</span>
  <span style=color:#f92672>}</span>

  stage <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Build&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    <span style=color:#75715e>// create ssh key credentials for jenkins
</span><span style=color:#75715e></span>    sshagent<span style=color:#f92672>(</span>credentials: <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;jenkins&#39;</span><span style=color:#f92672>])</span> <span style=color:#f92672>{</span>

    sh <span style=color:#e6db74>&#39;git clone --mirror ${source}/${project_path} .&#39;</span>

    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> dest<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
      sh <span style=color:#e6db74>&#34;git push --mirror ${dest[i]}/${project_path}&#34;</span>
    <span style=color:#f92672>}</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h3 id=job-mirror-repositories>Job: Mirror Repositories</h3><p>Another pipeline job, this one configured to run on a schedule (example: every day at 12:00AM).</p><p>The pipeline script defines the repositories and a few functions to simplify:</p><pre><code>def dest(String... repos) {
  return string(name: &quot;destination&quot;, value: repos.join(','))
}

def src(repo) {
  return string(name: &quot;source&quot;, value: repo)
}

def path(val) {
  return string(name: &quot;project_path&quot;, value: val)
}

node {
  def github = 'ssh://git@github.com'
  def bitbucket = 'ssh://git@bitbucket.org'
  def micrantha = 'ssh://git@git.micrantha.com:2222'

  build job: 'git_mirror', parameters: [
    src(github),
    dest(bitbucket, micrantha),
    path(&quot;ryjen/blog&quot;)
  ]

  build job: 'git_mirror', parameters: [
    src(github), dest(bitbucket, micrantha),
    path(&quot;ryjen/dotfiles&quot;)
  ]

  // etc...
}
</code></pre><h2 id=conclusion>Conclusion</h2><p>Not bad for a few jenkins jobs. I will enjoy the</p><ul><li>data loss redundancy</li><li>organization (housekeeping)</li><li>scheduling</li></ul><p>Maybe you will too. ðŸ˜Ž</p></div></div></div><hr><div class=container><div id=related><h5>Related:</h5><div class="card item bg-default post clearfix" data-link=/2020/06/25/git-notes-storage/><div class=card-header><h1>Git Notes Storage</h1><div class=card-sub-header><div>Jun 25, 2020</div><div>3 min read</div></div></div><div class=card-content><p>a small blurb on using git notes for versioning and a storage mechanism</p></div><div class=card-footer><div class=item-tags><span class=item-tag>git</span>
<span class=item-tag>version</span>
<span class=item-tag>notes</span></div></div></div><div class="card item bg-default post clearfix" data-link=/2018/01/22/fortunes-on-slack/><div class=card-header><h1>Fortunes on Slack</h1><div class=card-sub-header><div>Jan 22, 2018</div><div>3 min read</div></div></div><div class=card-content><p>witty antidotes in a service</p></div><div class=card-footer><div class=item-tags><span class=item-tag>golang</span>
<span class=item-tag>slack</span>
<span class=item-tag>api</span>
<span class=item-tag>droplet</span>
<span class=item-tag>micro-service</span>
<span class=item-tag>docker</span>
<span class=item-tag>dokku</span>
<span class=item-tag>HTTP</span>
<span class=item-tag>rest</span>
<span class=item-tag>go</span>
<span class=item-tag>fortunes</span>
<span class=item-tag>micrantha</span>
<span class=item-tag>postgres</span>
<span class=item-tag>git</span></div></div></div></div></div><hr><div class=container></div></div><div id=footer><script data-goatcounter=https://analytics.micrantha.com/count async src=//analytics.micrantha.com/count.js></script><button id=themer class=center type=button>enlighten</button><div class="menu center"><ul><li><a href=mailto:robert@ryanjennin.gs aria-label=email><i class="fa-3x fas fa-envelope"></i></a></li><li><a href=https://micrantha.com aria-label=biz><i class="fa-3x fas fa-building"></i></a></li><li><a href=https://github.com/ryjen aria-label=github><i class="fa-3x fab fa-github"></i></a></li><li><a href=https://linkedin.com/in/ryjen aria-label=linkedin><i class="fa-3x fab fa-linkedin"></i></a></li></ul></div><div class=center>Â© all rights reserved, ryan jennings</div></div><script src=/js/vendor.min.js defer></script><script src=/js/theme.min.js defer></script><script src=/js/app.min.js defer></script><script data-goatcounter=https://analytics.micrantha.com/count async src=//analytics.micrantha.com/count.js></script></body></html>