<!doctype html>
<html class="no-js" lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Deploy Docker Registry with Dokku</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="google-site-verification" content="jkdqcIgCmfBgfd8S0WbF3CqZ-TXSSayerVq4mqO0Fc0" />
<meta name="google-site-verification" content="Crk6W-ckoApRrOZrv23ngLwPPTbzjzfZ4AQPElgS0pw" />
<meta name="google-site-verification" content="Crk6W-ckoApRrOZrv23ngLwPPTbzjzfZ4AQPElgS0pw" />
<meta name="description" content="a namespace for technical and musical musings" />
<meta name="ROBOTS" CONTENT="INDEX, FOLLOW">

    
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,900;1,200;1,300;1,400;1,500;1,600;1,700;1,900&family=Source+Sans+Pro:ital,wght@0,200;0,300;0,400;0,600;0,700;0,900;1,200;1,300;1,400;1,600;1,700;1,900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/theme.min.css">


<link href="/css/app.min.css" rel="stylesheet">




    <meta name="generator" content="Hugo 0.73.0" />

  </head>
  <body>

    <div id="background">
    </div>

    

    
    <div id="header" class="clearfix">
    

      
      <div class="container clearfix">
        <div id="brand">
          <a href="/">
  <img src="/image/logo.svg" alt="logo" width="40" height="40" /> <span class="brand">ryan jennings</span>
</a>

        </div>
        <div id="menu-toggle">
        <i class="fas fa-bars"></i></div>
        <nav>
          
          <ul class="nav navbar-nav menu">
            
            <li class="nav-toggle blog">
              <a href="/post" title="blog">
                
                <i class="fas fa-rss"></i>
                
                <span class="nav-name">blog</span>
              </a>
            </li>
            
            <li class="nav-toggle music">
              <a href="/music" title="music">
                
                <i class="fas fa-music"></i>
                
                <span class="nav-name">music</span>
              </a>
            </li>
            
            <li class="nav-toggle doodles">
              <a href="/doodles" title="doodles">
                
                <i class="fas fa-paint-brush"></i>
                
                <span class="nav-name">doodles</span>
              </a>
            </li>
            
            <li class="nav-toggle things">
              <a href="/things" title="things">
                
                <i class="fas fa-object-ungroup"></i>
                
                <span class="nav-name">things</span>
              </a>
            </li>
            
          </ul>
          

          
          <ul class="nav navbar-icons context-menu">
            
            <li class="navbar-icon"><a href="mailto:robert@ryanjennin.gs"><i class="fas fa-envelope"></i></a></li>
            
            <li class="navbar-icon"><a href="https://micrantha.com"><i class="fas fa-building"></i></a></li>
            
            <li class="navbar-icon"><a href="https://github.com/ryjen"><i class="fab fa-github"></i></a></li>
            
            <li class="navbar-icon"><a href="https://linkedin.com/in/ryjen"><i class="fab fa-linkedin"></i></a></li>
            
          </ul>
          
        </nav>
      </div>
    </div>

    <div class="container">


<div id="main">

    <h1>Deploy Docker Registry with Dokku</h1>

    <p class="timestamps">Created: February 19, 2018 </p>

    <div class="text-justify"><h2 id="prerequisites">Prerequisites</h2>
<p>You&rsquo;ll need to prepare a bit.</p>
<hr>
<ol>
<li>A local path on the server to store registry data. For example: <code>/mydir/registry</code></li>
<li><a href="https://www.docker.com/community-edition#/download">Docker</a> installed on the client and server machine</li>
<li><a href="http://dokku.viewdocs.io/dokku/">Dokku</a> installed on the server</li>
</ol>
<h3 id="for-authentication">For Authentication</h3>
<ol>
<li>httpasswd command is installed</li>
</ol>
<h3 id="for-an-external-registry">For an External Registry</h3>
<ol>
<li>Dokku <a href="https://github.com/dokku/dokku-letsencrypt">letsencrypt plugin</a> installed</li>
<li>A working domain name pointing to the dokku app. For example, <em><a href="https://registry.mydomain.com">https://registry.mydomain.com</a></em></li>
</ol>
<h3 id="create-the-dokku-app">Create the dokku app</h3>
<p>Create the dokku app and retag a pre-existing repository image to it.
To persist data, a volume is used.</p>
<hr>
<ol>
<li>
<p>Create a new app named &ldquo;registry&rdquo; in dokku: <code>dokku apps:create registry</code></p>
</li>
<li>
<p>Go ahead an pull the docker registry image (using alpine for reduced size): <code>docker pull ses1er/alpine-registry</code></p>
</li>
<li>
<p>Now retag the image so dokku knows about it: <code>docker tag ses1er/alpine-registry dokku/registry</code></p>
</li>
<li>
<p>Deploy the image to dokku: <code>dokku tags:deploy registry</code></p>
</li>
</ol>
<h5 id="configure-the-app">Configure the app</h5>
<ol>
<li>
<p>Configure the local storage directory for the registry: <code>dokku config:set --no-restart registry REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY=&quot;/container/dir/registry&quot;</code></p>
</li>
<li>
<p>Now add an application mount point for the local storage directory: <code>dokku storage:mount registry /mydir/registry:/container/dir/registry</code> <em>(note: the default container location is /var/lib/registry)</em></p>
</li>
<li>
<p>Now remove the default http port mapping: <code>dokku proxy:ports-remove registry 80</code></p>
</li>
<li>
<p>And and a new one pointing to the repository: <code>dokku proxy:ports-add registry 80:5000 5000:5000</code></p>
</li>
</ol>
<h3 id="authorization">Authorization</h3>
<p>Require a valid login to create a repository.</p>
<hr>
<ol>
<li>
<p>Create a directory for authorization data in the local application volume: <code>mkdir -p /mydir/registry/auth</code></p>
</li>
<li>
<p>Create a username/password file: <code>htpasswd -Bn username &gt; /mydir/registry/auth/htpasswd</code> <em>(will prompt for password)</em></p>
</li>
<li>
<p>Add configuration variables to dokku registry app: <code>dokku config:set --no-restart registry REGISTRY_AUTH=htpasswd REGISTRY_AUTH_HTPASSWD_REALM=&quot;My Registry&quot; REGISTRY_AUTH_HTPASSWD_PATH=/container/dir/registry/auth/htpasswd</code></p>
</li>
</ol>
<h3 id="external-registry">External Registry</h3>
<p>To allow your registry to be remotely accessible.</p>
<hr>
<ol>
<li>
<p>Add your domain to the registry dokku app: <code>dokku domains:add registry https://registry.mydomain.com</code></p>
</li>
<li>
<p>Add letsencrypt to the app: <code>dokku letsencrypt registry</code> and ensure a valid certificate is always available: <code>dokku letsencrypt:auto-renew registry</code></p>
</li>
<li>
<p>Remove the default HTTPS port mapping: <code>dokku proxy:ports-remove 443</code></p>
</li>
<li>
<p>And add a new port mapping to the repository: <code>dokku proxy:ports-add 443:5000</code></p>
</li>
</ol>
<h3 id="testing">Testing</h3>
<p>Does it work?</p>
<hr>
<ol>
<li>
<p>Restart the server: <code>dokku ps:restart registry</code></p>
</li>
<li>
<p>You can test it by logging in from a remote machine (or local if not external facing): <code>docker login --username &lt;username&gt; https://registry.mydomain.com</code></p>
</li>
<li>
<p>Retag an image: <code>docker tag myimage registry.mydomain.com/username/myimage</code> and push it: <code>docker push registry.mydomain.com/username/myimage</code></p>
</li>
</ol>
<h4 id="gotchas">Gotchas</h4>
<p>There is always at least one.</p>
<hr>
<p>NGINX by default will throw an HTTP 413 error if your image is too big. To fix that we have to disable the max HTTP body size.</p>
<ol>
<li>
<p>Edit the configuration for the repository app: <code>vim /home/dokku/registry/nginx.conf</code></p>
</li>
<li>
<p>In any server{} blocks add: <code>client_max_body_size 0;</code> which will disable the max body size limitation.</p>
</li>
</ol>
<h4 id="conclusion">Conclusion</h4>
<p>Super easy to get a private docker repository running on dokku. Why would you want to?</p>
<ol>
<li>Because you can</li>
<li>Private registries are generally not free</li>
<li>Sometimes doesn&rsquo;t make sense for an image to be public</li>
<li>Control over your data from another country&rsquo;s jurisdiction</li>
</ol>
<p>For example, I have a docker image to run weechat with very customized configuration and only usable by me. I only want to run it on my server and attach to it when I need to.</p>
</div>

</div>

</div>





<hr>

<div class="container">


    <div id="related">
        <h5>Related:</h5>

         <div class="card item bg-default clearfix">

    
    

      

    <p class="pull-right">February 7, 2019</p>
    <h4><a href="/2019/02/07/a-self-hosting-journey/">A self hosting journey</a></h4>
    <h5>Setting up your own cloud services</h5>

     <span class="item-tag">self-hosting</span>  <span class="item-tag">hosting</span>  <span class="item-tag">docker</span>  <span class="item-tag">cloud</span>  <span class="item-tag">services</span>  <span class="item-tag">server</span> 

</div>
  <div class="card item bg-default clearfix">

    
    

      

    <p class="pull-right">January 22, 2018</p>
    <h4><a href="/2018/01/22/fortunes-on-slack/">Fortunes on Slack</a></h4>
    <h5>witty antidotes in a service</h5>

     <span class="item-tag">golang</span>  <span class="item-tag">slack</span>  <span class="item-tag">api</span>  <span class="item-tag">droplet</span>  <span class="item-tag">micro-service</span>  <span class="item-tag">docker</span>  <span class="item-tag">dokku</span>  <span class="item-tag">HTTP</span>  <span class="item-tag">rest</span>  <span class="item-tag">go</span>  <span class="item-tag">fortunes</span>  <span class="item-tag">micrantha</span>  <span class="item-tag">postgres</span>  <span class="item-tag">git</span> 

</div>
 

    </div>


</div>



<hr>

<div class="container">

	
	  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "arg3" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	

</div>


</div>

<div id="footer">




<script type="text/javascript">
  var _paq = window._paq || [];
   
  _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
  _paq.push(["setCookieDomain", "ryanjennin.gs"]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//analytics.micrantha.com/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//analytics.micrantha.com/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt="" /></p></noscript>








<div class="center">
	© all rights reserved, ryan jennings
</div>

</div>


<script src="/js/theme.min.js"></script>


<script src="/js/app.min.js"></script>


<script>hljs.initHighlightingOnLoad();</script>







</body>
</html>


