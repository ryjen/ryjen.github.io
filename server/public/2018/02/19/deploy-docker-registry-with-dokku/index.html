<!doctype html>
<html class="no-js" lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Deploy Docker Registry with Dokku</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

        <meta name="description" content="The fortunes api serves witty antidotes from the UNIX world that relieve project tensions.">
    <meta name="keywords" content="unix,fortunes,micrantha,ryjen,ryan,jennings,coda,humour,humor,micro,microservice,micro-service,api,poems,proverbs,cookie,definitions,joke">
    <link rel="manifest" href="site.webmanifest">
    <link rel="apple-touch-icon" href="/icon/icon.png">
        
    
<link rel="stylesheet" href="/css/font-awesome.min.css">
<link href="https://fonts.googleapis.com/css?family=Inconsolata|Lora|Raleway" rel="stylesheet">
<style type="text/css">
#header {
	
    background-color: mediumseagreen;
    

    
    color: whitesmoke;
    
}
</style>

<link rel="stylesheet" href="/css/coda.min.css">


 <link rel="stylesheet" href="/css/app.min.css"> 
 

    <meta name="generator" content="Hugo 0.37" />

</head>
<body>



<div id="header" class="clearfix">
    
    <div class="container clearfix">
        <span id="menu-toggle">&equiv;</span>
        <div id="brand">
			<a href="/">
	<img src="/image/logo-light.svg" alt="logo" width="40" height="40" /> <span>coda life</span>
</a>

        </div>
        <nav>
            
                <ul class="nav navbar-nav">
                    
                        <li class="nav-toggle blog">
                            
                            <i class="fa fa-rss"></i> 
                            
                            <a href="/post">blog</a>
                        </li>
                    
                        <li class="nav-toggle music">
                            
                            <i class="fa fa-music"></i> 
                            
                            <a href="/music">music</a>
                        </li>
                    
                        <li class="nav-toggle things">
                            
                            <i class="fa fa-object-ungroup"></i> 
                            
                            <a href="/things">things</a>
                        </li>
                    
                </ul>
            


            
                <ul class="nav navbar-icons">
                    
                        <li class="navbar-icon"><a href="mailto:ryan@coda.life"><i class="fa fa-envelope-o"></i></a></li>
                    
                        <li class="navbar-icon"><a href="https://github.com/ryjen/"><i class="fa fa-github"></i></a></li>
                    
                </ul>
            
        </nav>
    </div>
</div>

<div class="container">


<div id="main">

	<h2>Deploy Docker Registry with Dokku</h2>

    <div class="text-justify">

<h4 id="prerequisites">Prerequisites</h4>

<p>You&rsquo;ll need to prepare a bit.</p>

<hr />

<ol>
<li>A local path on the server to store registry data. For example: <code>/mydir/registry</code></li>
<li><a href="https://www.docker.com/community-edition#/download">Docker</a> installed on the client and server machine</li>
<li><a href="http://dokku.viewdocs.io/dokku/">Dokku</a> installed on the server</li>
</ol>

<h5 id="for-authentication">For Authentication</h5>

<ol>
<li>httpasswd command is installed</li>
</ol>

<h5 id="for-an-external-registry">For an External Registry</h5>

<ol>
<li>Dokku <a href="https://github.com/dokku/dokku-letsencrypt">letsencrypt plugin</a> installed</li>
<li>A working domain name pointing to the dokku app. For example, <em><a href="https://registry.mydomain.com">https://registry.mydomain.com</a></em></li>
</ol>

<h3 id="create-the-dokku-app">Create the dokku app</h3>

<p>Create the dokku app and retag a pre-existing repository image to it.
To persist data, a volume is used.</p>

<hr />

<ol>
<li><p>Create a new app named &ldquo;registry&rdquo; in dokku: <code>dokku apps:create registry</code></p></li>

<li><p>Go ahead an pull the docker registry image (using alpine for reduced size): <code>docker pull ses1er/alpine-registry</code></p></li>

<li><p>Now retag the image so dokku knows about it: <code>docker tag ses1er/alpine-registry dokku/registry</code></p></li>

<li><p>Deploy the image to dokku: <code>dokku tags:deploy registry</code></p></li>
</ol>

<h5 id="configure-the-app">Configure the app</h5>

<ol>
<li><p>Configure the local storage directory for the registry: <code>dokku config:set --no-restart registry REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY=&quot;/container/dir/registry&quot;</code></p></li>

<li><p>Now add an application mount point for the local storage directory: <code>dokku storage:mount registry /mydir/registry:/container/dir/registry</code>  <em>(note: the default container location is /var/lib/registry)</em></p></li>

<li><p>Now remove the default http port mapping: <code>dokku proxy:ports-remove registry 80</code></p></li>

<li><p>And and a new one pointing to the repository: <code>dokku proxy:ports-add registry 80:5000 5000:5000</code></p></li>
</ol>

<h3 id="authorization">Authorization</h3>

<p>Require a valid login to create a repository.</p>

<hr />

<ol>
<li><p>Create a directory for authorization data in the local application volume: <code>mkdir -p /mydir/registry/auth</code></p></li>

<li><p>Create a username/password file: <code>htpasswd -Bn username &gt; /mydir/registry/auth/htpasswd</code> <em>(will prompt for password)</em></p></li>

<li><p>Add configuration variables to dokku registry app: <code>dokku config:set --no-restart registry REGISTRY_AUTH=htpasswd REGISTRY_AUTH_HTPASSWD_REALM=&quot;My Registry&quot; REGISTRY_AUTH_HTPASSWD_PATH=/container/dir/registry/auth/htpasswd</code></p></li>
</ol>

<h3 id="external-registry">External Registry</h3>

<p>To allow your registry to be remotely accessible.</p>

<hr />

<ol>
<li><p>Add your domain to the registry dokku app: <code>dokku domains:add registry https://registry.mydomain.com</code></p></li>

<li><p>Add letsencrypt to the app: <code>dokku letsencrypt registry</code> and ensure a valid certificate is always available: <code>dokku letsencrypt:auto-renew registry</code></p></li>

<li><p>Remove the default HTTPS port mapping: <code>dokku proxy:ports-remove 443</code></p></li>

<li><p>And add a new port mapping to the repository: <code>dokku proxy:ports-add 443:5000</code></p></li>
</ol>

<h3 id="testing">Testing</h3>

<p>Does it work?</p>

<hr />

<ol>
<li><p>Restart the server: <code>dokku ps:restart registry</code></p></li>

<li><p>You can test it by logging in from a remote machine (or local if not external facing): <code>docker login --username &lt;username&gt; https://registry.mydomain.com</code></p></li>

<li><p>Retag an image: <code>docker tag myimage registry.mydomain.com/username/myimage</code> and push it: <code>docker push registry.mydomain.com/username/myimage</code></p></li>
</ol>

<h4 id="gotchas">Gotchas</h4>

<p>There is always at least one.</p>

<hr />

<p>NGINX by default will throw an HTTP 413 error if your image is too big.  To fix that we have to disable the max HTTP body size.</p>

<ol>
<li><p>Edit the configuration for the repository app: <code>vim /home/dokku/registry/nginx.conf</code></p></li>

<li><p>In any server{} blocks add: <code>client_max_body_size 0;</code> which will disable the max body size limitation.</p></li>
</ol>

<h4 id="conclusion">Conclusion</h4>

<p>Super easy to get a private docker repository running on dokku.   Why would you want to?</p>

<ol>
<li>Because you can</li>
<li>Private registries are generally not free</li>
<li>Sometimes doesn&rsquo;t make sense for an image to be public</li>
<li>Control over your data from another country&rsquo;s jurisdiction</li>
</ol>

<p>For example, I have a docker image to run weechat with very customized configuration and only usable by me.  I only want to run it on my server and attach to it when I need to.</p>
</div>

</div>

</div>





<hr>

<div class="container">


    <div id="related">
        <h5>Related:</h5>

         <div class="card item bg-default clearfix">

    
    

      

    <p class="pull-right">January 22, 2018</p>
    <h4><a href="/2018/01/22/fortunes-on-slack/">Fortunes on Slack</a></h4>
    <h5>witty antidotes in a service</h5>

     <span class="item-tag">golang</span>  <span class="item-tag">slack</span>  <span class="item-tag">api</span>  <span class="item-tag">droplet</span>  <span class="item-tag">micro-service</span>  <span class="item-tag">docker</span>  <span class="item-tag">dokku</span>  <span class="item-tag">HTTP</span>  <span class="item-tag">rest</span>  <span class="item-tag">go</span>  <span class="item-tag">fortunes</span>  <span class="item-tag">micrantha</span>  <span class="item-tag">postgres</span>  <span class="item-tag">git</span> 

</div>
 

    </div>


</div>



<hr>

<div class="container">

	
	  <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "arg3" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	

</div>


</div>

<div id="footer">

<div class="center">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-5084920929867043"
         data-ad-slot="3126644849"
         data-ad-format="auto"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>


<hr>




<div class="center">
	&copy; all rights reserved, ryan jennings
</div>

</div>

    <script src="/js/vendor/modernizr-3.5.0.min.js"></script>
<script>window.jQuery || document.write('<script src="/js/vendor/jquery-3.2.1.min.js"><\/script>')</script>
<script src="/js/vendor/highlight.pack.js"></script>

<script src="/js/coda.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>





 


</body>
</html>

